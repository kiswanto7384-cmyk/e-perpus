<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Perpus - Pengembalian & Denda</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen p-4 font-sans text-slate-800">

    <div class="max-w-4xl mx-auto">
        <div class="bg-indigo-700 p-6 rounded-[2rem] text-white shadow-lg mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black italic uppercase tracking-tighter">Pengembalian Buku</h1>
                <p class="text-[10px] font-bold opacity-80 uppercase tracking-widest">Sistem Denda Otomatis Saldo Kantin</p>
            </div>
            <div class="text-right">
                <p class="text-[10px] font-black opacity-60">DENDA/HARI</p>
                <p class="text-xl font-black text-yellow-400">Rp 1.000</p>
            </div>
        </div>

        <div class="bg-white rounded-[2rem] shadow-xl overflow-hidden border border-slate-200">
            <div class="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <h2 class="font-black uppercase italic text-slate-600 text-sm">ðŸ“š Daftar Pinjaman Belum Kembali</h2>
                <span id="totalPinjaman" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-[10px] font-black">0 Buku</span>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50 text-[9px] font-black uppercase text-slate-400 tracking-widest">
                            <th class="p-5">Peminjam</th>
                            <th class="p-5">Buku</th>
                            <th class="p-5">Tgl Kembali</th>
                            <th class="p-5">Denda</th>
                            <th class="p-5 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tabelPinjaman" class="text-[11px]">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // CONFIG FIREBASE (Gunakan config Bapak yang sudah ada)
        const firebaseConfig = { databaseURL: "https://ceklist-anak-indonesia-hebat-default-rtdb.asia-southeast1.firebasedatabase.app" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const DENDA_PER_HARI = 1000;

        function muatDataPinjaman() {
            // Kita asumsikan data pinjaman disimpan di node 'pinjaman_aktif'
            db.ref('pinjaman_aktif').on('value', snap => {
                const body = document.getElementById('tabelPinjaman');
                const countEl = document.getElementById('totalPinjaman');
                body.innerHTML = "";
                let count = 0;

                snap.forEach(child => {
                    count++;
                    const p = child.val();
                    const key = child.key;

                    // Hitung Denda
                    const hariIni = new Date();
                    hariIni.setHours(0,0,0,0);
                    const tglDeadline = new Date(p.tgl_kembali);
                    tglDeadline.setHours(0,0,0,0);

                    let denda = 0;
                    let telat = 0;
                    if (hariIni > tglDeadline) {
                        const selisih = hariIni.getTime() - tglDeadline.getTime();
                        telat = Math.ceil(selisih / (1000 * 60 * 60 * 24));
                        denda = telat * DENDA_PER_HARI;
                    }

                    body.innerHTML += `
                        <tr class="border-b border-slate-100 hover:bg-slate-50 transition-all">
                            <td class="p-5 font-black text-slate-700 uppercase">
                                ${p.nama_siswa}<br><span class="text-[8px] text-slate-400 font-bold">${p.kelas}</span>
                            </td>
                            <td class="p-5 font-bold italic text-indigo-600 uppercase">${p.judul_buku}</td>
                            <td class="p-5 font-bold ${telat > 0 ? 'text-red-500' : 'text-slate-500'}">
                                ${p.tgl_kembali}
                                ${telat > 0 ? `<br><span class="text-[8px] font-black uppercase">Telat ${telat} Hari</span>` : ''}
                            </td>
                            <td class="p-5 font-black text-sm ${denda > 0 ? 'text-red-600' : 'text-emerald-600'}">
                                Rp ${denda.toLocaleString()}
                            </td>
                            <td class="p-5 text-center">
                                <button onclick="prosesKembali('${key}', '${p.nama_siswa}', ${denda})" 
                                    class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-black uppercase text-[9px] shadow-md hover:bg-indigo-700 transition-all">
                                    Selesai âœ…
                                </button>
                            </td>
                        </tr>
                    `;
                });
                countEl.innerText = count + " Buku";
            });
        }

        function prosesKembali(key, namaSiswa, totalDenda) {
            const pathSiswa = namaSiswa.replace(/\s+/g, '_');
            
            if (totalDenda > 0) {
                if (confirm(`Siswa terlambat. Saldo Kantin ${namaSiswa} akan dipotong Rp ${totalDenda.toLocaleString()}. Lanjutkan?`)) {
                    // 1. Cek Saldo Terlebih Dahulu
                    db.ref('rekap_siswa/' + pathSiswa + '/saldo_kantin').once('value', snap => {
                        let saldo = snap.val() || 0;
                        if (saldo >= totalDenda) {
                            // 2. Potong Saldo
                            db.ref('rekap_siswa/' + pathSiswa).update({
                                saldo_kantin: saldo - totalDenda
                            }).then(() => {
                                selesaikanTransaksi(key, totalDenda);
                            });
                        } else {
                            alert("SALDO KANTIN TIDAK CUKUP! Tagihan harus dibayar manual atau top up.");
                        }
                    });
                }
            } else {
                if (confirm("Proses pengembalian buku tepat waktu?")) {
                    selesaikanTransaksi(key, 0);
                }
            }
        }

        function selesaikanTransaksi(key, denda) {
            // Pindahkan data ke riwayat dan hapus dari pinjaman aktif
            db.ref('pinjaman_aktif/' + key).once('value', snap => {
                const data = snap.val();
                data.tgl_dikembalikan = new Date().toLocaleDateString('id-ID');
                data.denda_dibayar = denda;

                // Masuk ke Riwayat
                db.ref('riwayat_perpus').push(data).then(() => {
                    // Hapus dari Aktif
                    db.ref('pinjaman_aktif/' + key).remove();
                    alert("Berhasil! Buku dikembalikan dan data diarsipkan.");
                });
            });
        }

        // Jalankan saat load
        muatDataPinjaman();

    </script>
</body>
</html>
