<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sirkulasi - E-Perpus SDN 169</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen pb-10">

    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200 px-4 py-3 mb-6">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <a href="menu-perpus.html" class="flex items-center gap-2">
                <span class="text-xl">ğŸ </span>
                <span class="font-black text-indigo-900 italic text-sm uppercase">Menu Utama</span>
            </a>
            <a href="pengembalian.html" class="px-3 py-2 rounded-xl text-[9px] font-black uppercase bg-indigo-100 text-indigo-600 shadow-sm hover:bg-indigo-200">ğŸ“‘ Log Pengembalian</a>
        </div>
    </nav>

    <div class="max-w-2xl mx-auto px-4">
        <div class="bg-indigo-600 text-white p-6 rounded-[2.5rem] shadow-xl mb-6 border-b-8 border-indigo-800">
            <h1 class="text-xl font-black uppercase italic leading-none text-yellow-400">Kasir Sirkulasi ğŸ”„</h1>
            <p class="text-[9px] font-bold opacity-80 uppercase tracking-widest mt-2">Update Otomatis & Hitung Denda</p>
        </div>

        <div id="scannerArea" class="hidden mb-6 rounded-[2.5rem] overflow-hidden border-4 border-indigo-500 bg-black relative shadow-2xl">
            <div id="reader" style="width: 100%; min-height: 250px;"></div>
            <button onclick="tutupScanner()" class="w-full bg-red-600 text-white py-4 font-black text-xs uppercase tracking-widest">Batal Scan âŒ</button>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-200 space-y-4">
            
            <div class="relative">
                <label class="text-[8px] font-black text-slate-400 ml-3 uppercase">1. Identitas Peminjam</label>
                <input type="text" id="nisSiswa" placeholder="ID SISWA / SCAN..." 
                    class="w-full p-5 bg-slate-50 rounded-2xl font-black outline-none border-2 border-transparent focus:border-indigo-500 uppercase text-sm tracking-widest transition-all">
                <button onclick="bukaScanner('nisSiswa')" class="absolute right-2 top-[22px] bottom-2 bg-indigo-600 text-white px-4 rounded-xl font-black text-[10px] hover:bg-indigo-700 transition-all">ğŸ“· SCAN</button>
            </div>

            <div id="infoSiswa" class="hidden p-5 bg-blue-50 rounded-2xl border-2 border-blue-100">
                <div class="flex items-center gap-4">
                    <div class="text-3xl">ğŸ‘¤</div>
                    <div>
                        <p id="namaSiswaDisplay" class="font-black text-indigo-900 uppercase text-sm"></p>
                        <p id="kelasSiswaDisplay" class="text-[10px] font-bold text-indigo-500 uppercase"></p>
                    </div>
                </div>
            </div>

            <hr class="border-slate-100">

            <div class="relative">
                <label class="text-[8px] font-black text-slate-400 ml-3 uppercase">2. Barcode Buku</label>
                <input type="text" id="barcodeBuku" placeholder="KODE BUKU / SCAN..." 
                    class="w-full p-5 bg-slate-50 rounded-2xl font-black outline-none border-2 border-transparent focus:border-orange-500 uppercase text-sm tracking-widest transition-all">
                <button onclick="bukaScanner('barcodeBuku')" class="absolute right-2 top-[22px] bottom-2 bg-orange-500 text-white px-4 rounded-xl font-black text-[10px] hover:bg-orange-600 transition-all">ğŸ“· SCAN</button>
            </div>

            <div id="infoBuku" class="hidden p-5 bg-orange-50 rounded-2xl border-2 border-orange-100">
                <div class="flex items-center gap-4">
                    <div class="text-3xl">ğŸ“–</div>
                    <div>
                        <p id="judulBukuDisplay" class="font-black text-orange-900 uppercase text-sm"></p>
                        <p id="stokBukuDisplay" class="text-[10px] font-bold text-orange-500 uppercase"></p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 pt-4">
                <button onclick="prosesTransaksi('PINJAM')" class="bg-indigo-600 text-white font-black py-5 rounded-3xl shadow-lg hover:bg-indigo-700 active:scale-95 transition-all uppercase italic text-xs tracking-widest">Pinjam ğŸ“¤</button>
                <button onclick="prosesTransaksi('KEMBALI')" class="bg-emerald-500 text-white font-black py-5 rounded-3xl shadow-lg hover:bg-emerald-600 active:scale-95 transition-all uppercase italic text-xs tracking-widest">Kembali ğŸ“¥</button>
            </div>
        </div>
    </div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = { databaseURL: "https://e-perpus-a652c-default-rtdb.asia-southeast1.firebasedatabase.app" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let html5QrCode = null;

        // Listener Input Manual
        document.getElementById('nisSiswa').addEventListener('input', (e) => cariSiswa(e.target.value.trim()));
        document.getElementById('barcodeBuku').addEventListener('input', (e) => cariBuku(e.target.value.trim()));

        function bukaScanner(idTujuan) {
            document.getElementById('scannerArea').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 20, qrbox: { width: 250, height: 150 } },
                (decodedText) => {
                    const hasil = decodedText.trim();
                    document.getElementById(idTujuan).value = hasil;
                    if(idTujuan === 'nisSiswa') cariSiswa(hasil);
                    if(idTujuan === 'barcodeBuku') cariBuku(hasil);
                    tutupScanner();
                    new Audio('https://www.soundjay.com/buttons/beep-07.mp3').play();
                }
            ).catch(err => console.error("Scanner Error: ", err));
        }

        function tutupScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scannerArea').classList.add('hidden');
                }).catch(() => document.getElementById('scannerArea').classList.add('hidden'));
            }
        }

        function cariSiswa(nis) {
            if(!nis) return;
            db.ref('anggota_perpus/' + nis).once('value', snap => {
                if(snap.exists()){
                    const s = snap.val();
                    document.getElementById('infoSiswa').classList.remove('hidden');
                    document.getElementById('namaSiswaDisplay').innerText = s.nama;
                    document.getElementById('kelasSiswaDisplay').innerText = "Kelas: " + s.kelas;
                }
            });
        }

        function cariBuku(barcode) {
            if(!barcode) return;
            db.ref('koleksi_buku/' + barcode).once('value', snap => {
                if(snap.exists()){
                    const b = snap.val();
                    document.getElementById('infoBuku').classList.remove('hidden');
                    document.getElementById('judulBukuDisplay').innerText = b.judul;
                    document.getElementById('stokBukuDisplay').innerText = "Tersedia: " + b.stok_tersedia;
                }
            });
        }

        async function prosesTransaksi(tipe) {
            const nis = document.getElementById('nisSiswa').value;
            const barcode = document.getElementById('barcodeBuku').value;
            const nama = document.getElementById('namaSiswaDisplay').innerText;
            const judul = document.getElementById('judulBukuDisplay').innerText;
            
            if(!nis || !barcode) return alert("âŒ NIS atau Barcode belum terisi!");

            const tglSkrg = new Date().toLocaleString('id-ID');
            const tsSkrg = new Date().getTime();
            const BATAS_HARI = 7;
            const DENDA_PER_HARI = 1000;

            if (tipe === 'PINJAM') {
                // LOGIKA PINJAM
                const dataBaru = {
                    idSiswa: nis,
                    namaSiswa: nama,
                    idBuku: barcode,
                    judulBuku: judul,
                    status: "DIPINJAM",
                    waktuPinjam: tglSkrg,
                    waktuKembali: "-",
                    timestamp: tsSkrg
                };
                await db.ref('perpus_laporan').push(dataBaru);
                await updateStok(barcode, -1);
                alert("âœ… BERHASIL PINJAM!");
                location.reload();

            } else {
                // LOGIKA KEMBALI (SINKRON KE PENGEMBALIAN)
                db.ref('perpus_laporan').orderByChild('idSiswa').equalTo(nis).once('value', async (snap) => {
                    let ditemukan = false;
                    let targetKey = null;
                    let dendaHitung = 0;

                    snap.forEach(child => {
                        const data = child.val();
                        if (data.idBuku === barcode && data.status === "DIPINJAM") {
                            ditemukan = true;
                            targetKey = child.key;

                            // Hitung Denda Otomatis
                            const selisihHari = Math.floor((tsSkrg - data.timestamp) / (1000 * 60 * 60 * 24));
                            if (selisihHari > BATAS_HARI) {
                                dendaHitung = (selisihHari - BATAS_HARI) * DENDA_PER_HARI;
                            }
                        }
                    });

                    if (ditemukan) {
                        // 1. Update data agar muncul di halaman pengembalian
                        await db.ref('perpus_laporan/' + targetKey).update({
                            status: "DIKEMBALIKAN",
                            waktuKembali: tglSkrg,
                            denda_final: dendaHitung,
                            waktu_proses: tsSkrg
                        });

                        // 2. Update Stok & Saldo
                        await updateStok(barcode, 1);
                        if(dendaHitung > 0) await updateSaldo(nis, dendaHitung);

                        alert(`âœ… BERHASIL KEMBALI!\nDenda: Rp ${dendaHitung.toLocaleString()}`);
                        location.reload();
                    } else {
                        alert("âŒ Data peminjaman aktif tidak ditemukan!");
                    }
                });
            }
        }

        async function updateStok(id, qty) {
            await db.ref('koleksi_buku/' + id).transaction(c => {
                if(c) c.stok_tersedia = (parseInt(c.stok_tersedia) || 0) + qty;
                return c;
            });
        }

        async function updateSaldo(nis, denda) {
            const ref = db.ref('anggota_perpus/' + nis);
            const s = await ref.once('value');
            if(s.exists()){
                const lama = s.val().saldo || 0;
                await ref.update({ saldo: lama - denda });
            }
        }
    </script>
</body>
</html>
