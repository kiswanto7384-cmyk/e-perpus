<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sirkulasi Buku - E-Perpus</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="bg-slate-100 p-4 font-sans min-h-screen">

    <div class="max-w-md mx-auto">
        <div class="bg-indigo-900 text-white p-6 rounded-[2rem] shadow-xl mb-6 text-center border-b-4 border-yellow-400">
            <h1 class="text-xl font-black uppercase italic leading-none">E-PERPUS SISTEM</h1>
            <p class="text-[10px] font-bold text-indigo-300 uppercase mt-1">Peminjaman & Pengembalian Buku</p>
        </div>

        <div id="scannerArea" class="hidden mb-6 rounded-[2rem] overflow-hidden border-4 border-indigo-600 bg-black">
            <div id="reader"></div>
            <button onclick="tutupScanner()" class="w-full bg-red-600 text-white py-3 font-black uppercase text-[10px]">Tutup Kamera</button>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-200 mb-6">
            <div class="space-y-4">
                <div class="relative">
                    <input type="text" id="idSiswa" placeholder="ID KARTU" class="w-full p-4 bg-slate-50 rounded-2xl font-black outline-none border-2 border-transparent focus:border-indigo-500">
                    <button onclick="bukaScanner()" class="absolute right-2 top-2 bg-indigo-600 text-white px-4 py-2 rounded-xl font-black text-[10px]">SCAN ðŸ“·</button>
                </div>
                <div id="infoSiswa" class="hidden p-3 bg-indigo-50 rounded-2xl border border-indigo-100">
                    <p id="displayNama" class="text-xs font-black text-indigo-900 uppercase"></p>
                    <p id="displayKelas" class="text-[10px] font-bold text-indigo-400"></p>
                </div>
                <input type="text" id="judulBuku" placeholder="JUDUL BUKU / KODE BUKU" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-xs outline-none border-2 border-transparent focus:border-emerald-500 uppercase">
                
                <button onclick="prosesPinjam()" class="w-full bg-emerald-500 text-white font-black py-4 rounded-2xl shadow-lg uppercase text-xs tracking-widest active:scale-95 transition-all">Catat Peminjaman ðŸ“š</button>
            </div>
        </div>

        <h3 class="text-[10px] font-black text-slate-400 uppercase mb-3 ml-2 italic">Buku Belum Kembali</h3>
        <div id="listPinjam" class="space-y-3"></div>
    </div>

    <script>
        // CONFIG SAMA DENGAN E-KANTIN (SINGAPURA)
        const firebaseConfig = {
            apiKey: "AIzaSyCUjE8WXa8Py4vnojrXDUR3uCvnQEzP6zQ",
            authDomain: "e-kantin-91f0c.firebaseapp.com",
            databaseURL: "https://e-kantin-91f0c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "e-kantin-91f0c",
            storageBucket: "e-kantin-91f0c.firebasestorage.app",
            messagingSenderId: "981834126006",
            appId: "1:981834126006:web:dac8bb0ec1da90549b4c17"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let html5QrCode;

        function bukaScanner() {
            document.getElementById('scannerArea').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (id) => {
                document.getElementById('idSiswa').value = id.trim();
                tutupScanner();
                cekSiswa(id.trim());
            });
        }

        function tutupScanner() {
            if (html5QrCode) html5QrCode.stop().then(() => { document.getElementById('scannerArea').classList.add('hidden'); });
        }

        function cekSiswa(id) {
            db.ref('kantin_users/' + id).once('value', snap => {
                const s = snap.val();
                if(s) {
                    document.getElementById('infoSiswa').classList.remove('hidden');
                    document.getElementById('displayNama').innerText = s.nama;
                    document.getElementById('displayKelas').innerText = s.kelas;
                } else {
                    alert("Siswa tidak ditemukan di database!");
                    document.getElementById('infoSiswa').classList.add('hidden');
                }
            });
        }

        // Jalankan cekSiswa jika ID diketik manual
        document.getElementById('idSiswa').addEventListener('change', (e) => cekSiswa(e.target.value.trim()));

        function prosesPinjam() {
            const id = document.getElementById('idSiswa').value.trim();
            const buku = document.getElementById('judulBuku').value.trim().toUpperCase();
            const nama = document.getElementById('displayNama').innerText;
            const kelas = document.getElementById('displayKelas').innerText;

            if(id && buku && nama) {
                const logRef = db.ref('perpus_laporan').push();
                logRef.set({
                    idPinjam: logRef.key,
                    idSiswa: id,
                    nama: nama,
                    kelas: kelas,
                    buku: buku,
                    tglPinjam: new Date().toLocaleString('id-ID'),
                    status: "DIPINJAM"
                }).then(() => {
                    alert("Peminjaman Berhasil Dicatat!");
                    document.getElementById('judulBuku').value = "";
                });
            } else { alert("Lengkapi data!"); }
        }

        // Muat Riwayat Pinjam (Status: DIPINJAM)
        db.ref('perpus_laporan').orderByChild('status').equalTo('DIPINJAM').on('value', snap => {
            const cont = document.getElementById('listPinjam'); cont.innerHTML = "";
            snap.forEach(child => {
                const d = child.val();
                cont.innerHTML += `
                    <div class="bg-white p-4 rounded-[1.5rem] shadow-sm border-l-4 border-orange-500 flex justify-between items-center">
                        <div class="flex-1">
                            <p class="text-[10px] font-black text-indigo-600 uppercase leading-none">${d.buku}</p>
                            <p class="text-[9px] font-bold text-slate-700 mt-1">${d.nama} (${d.kelas})</p>
                            <p class="text-[8px] text-slate-400 italic">${d.tglPinjam}</p>
                        </div>
                        <button onclick="kembalikanBuku('${d.idPinjam}')" class="bg-slate-800 text-white px-3 py-2 rounded-xl text-[8px] font-black">KEMBALI</button>
                    </div>`;
            });
        });

        function kembalikanBuku(id) {
            if(confirm("Buku sudah dikembalikan?")) {
                db.ref('perpus_laporan/' + id).update({
                    status: "KEMBALI",
                    tglKembali: new Date().toLocaleString('id-ID')
                });
            }
        }
    </script>
</body>
</html>
