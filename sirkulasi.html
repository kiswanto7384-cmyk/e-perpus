<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sirkulasi - E-Perpus</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-10">

    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200 px-4 py-3 mb-6">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <a href="menu-perpus.html" class="flex items-center gap-2">
                <span class="text-xl">ğŸ“š</span>
                <span class="font-black text-indigo-900 italic text-sm tracking-tighter uppercase">E-Perpus</span>
            </a>
            <div class="flex gap-2 overflow-x-auto no-scrollbar ml-4">
                <a href="sirkulasi.html" class="whitespace-nowrap px-3 py-2 rounded-xl text-[9px] font-black uppercase bg-indigo-600 text-white shadow-sm">ğŸ”„ Sirkulasi</a>
                <a href="katalog.html" class="whitespace-nowrap px-3 py-2 rounded-xl text-[9px] font-black uppercase hover:bg-orange-50 transition-colors text-slate-600">ğŸ“– Katalog</a>
                <a href="daftar-anggota.html" class="whitespace-nowrap px-3 py-2 rounded-xl text-[9px] font-black uppercase hover:bg-emerald-50 transition-colors text-slate-600">ğŸ‘¤ Member</a>
                <a href="log-sirkulasi.html" class="whitespace-nowrap px-3 py-2 rounded-xl text-[9px] font-black uppercase hover:bg-slate-100 transition-colors text-slate-600">ğŸ“œ Log</a>
            </div>
        </div>
    </nav>

    <div class="max-w-md mx-auto px-4">
        <div class="bg-indigo-900 text-white p-6 rounded-[2rem] shadow-xl mb-6 text-center border-b-4 border-yellow-400">
            <h1 class="text-xl font-black uppercase italic leading-none">SIRKULASI PERPUS ğŸ“š</h1>
            <p class="text-[10px] font-bold text-indigo-300 uppercase mt-1">Scan Kartu & Barcode Buku</p>
        </div>

        <div id="scannerArea" class="hidden mb-6 rounded-[2rem] overflow-hidden border-4 border-indigo-600 bg-black relative">
            <div id="reader"></div>
            <button onclick="tutupScanner()" class="w-full bg-red-600 text-white py-3 font-black uppercase text-[10px]">Tutup Kamera âŒ</button>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-200 mb-6 space-y-4">
            <div>
                <label class="text-[9px] font-black text-slate-400 ml-2 uppercase">1. Identitas Siswa</label>
                <div class="flex gap-2 mt-1">
                    <input type="text" id="idSiswa" placeholder="ID KARTU" class="flex-1 p-4 bg-slate-50 rounded-2xl font-black text-xs outline-none border-2 border-transparent focus:border-indigo-500 uppercase">
                    <button onclick="bukaScanner('siswa')" class="bg-indigo-600 text-white px-4 rounded-xl font-black text-[10px]">SCAN ğŸ“·</button>
                </div>
                <div id="infoSiswa" class="hidden mt-2 p-3 bg-indigo-50 rounded-xl border border-indigo-100">
                    <p id="displayNama" class="text-xs font-black text-indigo-900 uppercase"></p>
                    <p id="displayKelas" class="text-[9px] font-bold text-indigo-400"></p>
                </div>
            </div>

            <hr class="border-slate-100">

            <div>
                <label class="text-[9px] font-black text-slate-400 ml-2 uppercase">2. Barcode Buku</label>
                <div class="flex gap-2 mt-1">
                    <input type="text" id="idBuku" placeholder="SCAN BARCODE BUKU" class="flex-1 p-4 bg-slate-50 rounded-2xl font-black text-xs outline-none border-2 border-transparent focus:border-emerald-500 uppercase">
                    <button onclick="bukaScanner('buku')" class="bg-emerald-600 text-white px-4 rounded-xl font-black text-[10px]">SCAN ğŸ“–</button>
                </div>
                <div id="infoBuku" class="hidden mt-2 p-3 bg-emerald-50 rounded-xl border border-emerald-100">
                    <p id="displayJudul" class="text-xs font-black text-emerald-900 uppercase"></p>
                    <p id="displayPenulis" class="text-[9px] font-bold text-emerald-400"></p>
                </div>
            </div>

            <button onclick="prosesPinjam()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-lg uppercase text-xs tracking-widest active:scale-95 transition-all">Catat Peminjaman âœ…</button>
        </div>

        <h3 class="text-[10px] font-black text-slate-400 uppercase mb-3 ml-2 italic">Buku Belum Kembali</h3>
        <div id="listPinjam" class="space-y-3"></div>
    </div>

    <script>
        // CONFIG FIREBASE PERPUS
        const firebaseConfig = {
            apiKey: "AIzaSyBXt0gEgczYD1jQ9OhNk5FGN8CePIFaSYw",
            authDomain: "e-perpus-a652c.firebaseapp.com",
            databaseURL: "https://e-perpus-a652c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "e-perpus-a652c"
        };
        // CONFIG KANTIN (UNTUK CEK DATA SISWA)
        const kantinConfig = {
            databaseURL: "https://e-kantin-91f0c-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const appKantin = firebase.initializeApp(kantinConfig, "kantinApp");
        
        const db = firebase.database();
        const dbKantin = appKantin.database();
        let scannerInstance = null;
        let modeScan = "";

        function bukaScanner(mode) {
            modeScan = mode;
            document.getElementById('scannerArea').classList.remove('hidden');
            scannerInstance = new Html5Qrcode("reader");
            scannerInstance.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, (id) => {
                if(modeScan === "siswa") {
                    document.getElementById('idSiswa').value = id;
                    cekSiswa(id);
                } else {
                    document.getElementById('idBuku').value = id;
                    cekBuku(id);
                }
                tutupScanner();
            });
        }

        function tutupScanner() {
            if (scannerInstance) {
                scannerInstance.stop().then(() => { 
                    document.getElementById('scannerArea').classList.add('hidden'); 
                    scannerInstance = null;
                });
            }
        }

        function cekSiswa(id) {
            dbKantin.ref('kantin_users/' + id).once('value', snap => {
                const s = snap.val();
                if(s) {
                    document.getElementById('infoSiswa').classList.remove('hidden');
                    document.getElementById('displayNama').innerText = s.nama;
                    document.getElementById('displayKelas').innerText = s.kelas;
                } else { alert("Siswa tidak ditemukan di database!"); }
            });
        }

        function cekBuku(id) {
            db.ref('koleksi_buku/' + id).once('value', snap => {
                const b = snap.val();
                if(b) {
                    document.getElementById('infoBuku').classList.remove('hidden');
                    document.getElementById('displayJudul').innerText = b.judul;
                    document.getElementById('displayPenulis').innerText = b.penulis;
                } else { alert("Buku tidak terdaftar di katalog!"); }
            });
        }

        function prosesPinjam() {
            const idS = document.getElementById('idSiswa').value;
            const idB = document.getElementById('idBuku').value;
            const nama = document.getElementById('displayNama').innerText;
            const judul = document.getElementById('displayJudul').innerText;

            if(idS && idB && nama && judul) {
                const logRef = db.ref('perpus_laporan').push();
                logRef.set({
                    idPinjam: logRef.key,
                    idSiswa: idS,
                    namaSiswa: nama,
                    idBuku: idB,
                    judulBuku: judul,
                    tglPinjam: new Date().toLocaleString('id-ID'),
                    status: "DIPINJAM"
                }).then(() => {
                    alert("Peminjaman Berhasil!");
                    location.reload();
                });
            } else { alert("Pastikan Siswa dan Buku sudah ter-scan!"); }
        }

        db.ref('perpus_laporan').orderByChild('status').equalTo('DIPINJAM').on('value', snap => {
            const cont = document.getElementById('listPinjam'); cont.innerHTML = "";
            snap.forEach(c => {
                const d = c.val();
                cont.innerHTML += `
                    <div class="bg-white p-4 rounded-3xl shadow-sm border-l-4 border-orange-500 flex justify-between items-center">
                        <div>
                            <p class="text-[10px] font-black text-indigo-900 leading-none">${d.judulBuku}</p>
                            <p class="text-[8px] font-bold text-slate-400 uppercase mt-1">${d.namaSiswa}</p>
                        </div>
                        <button onclick="kembali('${d.idPinjam}')" class="bg-slate-800 text-white px-3 py-2 rounded-xl text-[8px] font-black">KEMBALI</button>
                    </div>`;
            });
        });

        function kembali(id) {
            if(confirm("Buku sudah diterima kembali?")) {
                db.ref('perpus_laporan/' + id).update({ 
                    status: "KEMBALI", 
                    tglKembali: new Date().toLocaleString('id-ID') 
                });
            }
        }
    </script>
</body>
</html>
