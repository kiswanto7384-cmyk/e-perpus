<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sirkulasi Perpus - PINJAM & KEMBALI</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="bg-slate-100 min-h-screen font-sans">

    <div class="max-w-4xl mx-auto p-4">
        <div class="bg-indigo-700 text-white p-6 rounded-[2.5rem] shadow-xl mb-6 flex justify-between items-center border-b-8 border-indigo-900">
            <div>
                <h1 class="text-xl font-black uppercase italic italic">Sirkulasi Perpus ðŸ”„</h1>
                <p class="text-[9px] font-bold opacity-70 uppercase tracking-widest">Pinjam & Pengembalian Buku</p>
            </div>
            <button onclick="location.reload()" class="bg-white/20 p-3 rounded-full hover:bg-white/30">ðŸ”„</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
                <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-indigo-50">
                    <h2 class="text-[10px] font-black text-slate-400 uppercase mb-4 text-center">Scan Barcode (Siswa/Buku)</h2>
                    <div id="reader" class="rounded-[2rem] overflow-hidden border-4 border-slate-100 mb-4"></div>
                    
                    <div class="flex gap-2">
                        <input type="text" id="manualInput" placeholder="Ketik Manual..." class="flex-1 p-3 bg-slate-100 rounded-xl text-xs font-bold outline-none">
                        <button onclick="prosesInput(document.getElementById('manualInput').value)" class="bg-indigo-600 text-white px-4 rounded-xl font-bold text-xs">OK</button>
                    </div>
                </div>

                <div id="infoBox" class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-indigo-50 min-h-[150px]">
                    <p class="text-center text-slate-300 text-xs mt-10 italic">Belum ada data yang di-scan</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-indigo-50">
                <h2 class="text-[10px] font-black text-indigo-500 uppercase mb-4">Peminjaman Berjalan</h2>
                <div id="listPinjam" class="space-y-3 overflow-y-auto max-h-[500px]">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // PAKAI CONFIG FIREBASE PERPUS BAPAK
        const firebaseConfig = {
            apiKey: "ISI_API_KEY_BAPAK",
            authDomain: "ISI_AUTH_DOMAIN",
            databaseURL: "ISI_DATABASE_URL",
            projectId: "ISI_PROJECT_ID",
            storageBucket: "ISI_STORAGE",
            messagingSenderId: "ISI_SENDER_ID",
            appId: "ISI_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let dataSiswa = null;
        let dataBuku = null;
        let scanner = new Html5Qrcode("reader");

        // Jalankan Kamera
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
            prosesInput(decodedText.trim());
        });

        async function prosesInput(id) {
            // 1. Cek apakah ini ID Siswa
            const siswaSnap = await db.ref('anggota_perpus/' + id).once('value');
            if (siswaSnap.exists()) {
                dataSiswa = siswaSnap.val();
                updateDisplay();
                return;
            }

            // 2. Cek apakah ini Barcode Buku
            const bukuSnap = await db.ref('koleksi_buku/' + id).once('value');
            if (bukuSnap.exists()) {
                dataBuku = bukuSnap.val();
                updateDisplay();
                return;
            }

            alert("Data tidak dikenali sebagai Siswa atau Buku!");
        }

        function updateDisplay() {
            const box = document.getElementById('infoBox');
            box.innerHTML = `
                <div class="space-y-4">
                    <div class="p-4 bg-amber-50 rounded-2xl border border-amber-100">
                        <p class="text-[8px] font-black text-amber-600 uppercase tracking-widest">Peminjam:</p>
                        <p class="font-black text-slate-800">${dataSiswa ? dataSiswa.nama : '<span class="text-slate-300">Belum Scan Kartu</span>'}</p>
                    </div>
                    <div class="p-4 bg-indigo-50 rounded-2xl border border-indigo-100">
                        <p class="text-[8px] font-black text-indigo-600 uppercase tracking-widest">Buku:</p>
                        <p class="font-black text-slate-800">${dataBuku ? dataBuku.judul : '<span class="text-slate-300">Belum Scan Buku</span>'}</p>
                    </div>
                    ${dataSiswa && dataBuku ? 
                        `<button onclick="eksekusiPinjam()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-lg uppercase text-xs">Proses Pinjam âœ…</button>` 
                        : ''}
                </div>
            `;
        }

        function eksekusiPinjam() {
            if (dataBuku.stok_tersedia <= 0) return alert("Maaf, stok buku ini sedang kosong!");

            const tglPinjam = new Date();
            const tglKembali = new Date();
            tglKembali.setDate(tglPinjam.getDate() + 7); // Durasi pinjam 7 hari

            const pinjamID = dataSiswa.id + "_" + dataBuku.isbn;

            // 1. Simpan ke Peminjaman Aktif
            db.ref('peminjaman_aktif/' + pinjamID).set({
                idSiswa: dataSiswa.id,
                namaSiswa: dataSiswa.nama,
                isbn: dataBuku.isbn,
                judulBuku: dataBuku.judul,
                tglPinjam: tglPinjam.toLocaleDateString('id-ID'),
                tglJatuhTempo: tglKembali.toLocaleDateString('id-ID')
            });

            // 2. Kurangi Stok Buku
            db.ref('koleksi_buku/' + dataBuku.isbn + '/stok_tersedia').transaction(s => (s || 0) - 1);

            alert("Buku Berhasil Dipinjam!");
            location.reload();
        }

        // Tampilkan Pinjaman Aktif & Fitur Kembali
        db.ref('peminjaman_aktif').on('value', snap => {
            const list = document.getElementById('listPinjam');
            list.innerHTML = "";
            snap.forEach(pSnap => {
                const p = pSnap.val();
                list.innerHTML += `
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-black text-[11px] text-slate-800 uppercase">${p.judulBuku}</h4>
                                <p class="text-[9px] font-bold text-indigo-600 uppercase">Peminjam: ${p.namaSiswa}</p>
                                <p class="text-[8px] text-slate-400 font-bold mt-1">Tempo: ${p.tglJatuhTempo}</p>
                            </div>
                            <button onclick="kembalikanBuku('${pSnap.key}', '${p.isbn}')" class="bg-emerald-500 text-white text-[8px] font-black px-3 py-2 rounded-lg uppercase">Kembali</button>
                        </div>
                    </div>
                `;
            });
        });

        function kembalikanBuku(key, isbn) {
            if (confirm("Konfirmasi pengembalian buku?")) {
                // 1. Hapus dari pinjaman aktif
                db.ref('peminjaman_aktif/' + key).remove();
                // 2. Tambah stok buku kembali
                db.ref('koleksi_buku/' + isbn + '/stok_tersedia').transaction(s => (s || 0) + 1);
                alert("Buku telah dikembalikan!");
            }
        }
    </script>
</body>
</html>
