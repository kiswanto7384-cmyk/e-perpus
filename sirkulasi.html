<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sirkulasi Realtime - E-Perpus SDN 169</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        .input-active { border-color: #4f46e5 !important; background-color: #f8fafc !important; }
        .loading-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-10">

    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200 px-4 py-3 mb-6">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <a href="menu-perpus.html" class="flex items-center gap-2">
                <span class="text-xl">üè†</span>
                <span class="font-black text-indigo-900 italic text-sm uppercase">Menu Utama</span>
            </a>
            <a href="pengembalian.html" class="px-3 py-2 rounded-xl text-[9px] font-black uppercase bg-indigo-100 text-indigo-600 shadow-sm hover:bg-indigo-200">üìë Log Pengembalian</a>
        </div>
    </nav>

    <div class="max-w-2xl mx-auto px-4">
        <div class="bg-indigo-600 text-white p-6 rounded-[2.5rem] shadow-xl mb-6 border-b-8 border-indigo-800">
            <h1 class="text-xl font-black uppercase italic leading-none text-yellow-400">Kasir Sirkulasi üîÑ</h1>
            <p class="text-[9px] font-bold opacity-80 uppercase tracking-widest mt-2 italic">Akses Multi-Perangkat Tanpa Lag</p>
        </div>

        <div id="scannerArea" class="hidden mb-6 rounded-[2.5rem] overflow-hidden border-4 border-indigo-500 bg-black relative shadow-2xl">
            <div id="reader" style="width: 100%; min-height: 250px;"></div>
            <button onclick="tutupScanner()" class="w-full bg-red-600 text-white py-4 font-black text-xs uppercase tracking-widest">Batal Scan ‚ùå</button>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-200 space-y-4">
            
            <div class="relative">
                <label class="text-[8px] font-black text-slate-400 ml-3 uppercase italic">1. Identitas Peminjam</label>
                <input type="text" id="nisSiswa" autocomplete="off" oninput="cariSiswa(this.value.trim())" placeholder="ID SISWA / SCAN..." 
                    class="w-full p-5 bg-slate-50 rounded-2xl font-black outline-none border-2 border-transparent focus:border-indigo-500 uppercase text-sm tracking-widest transition-all">
                <button onclick="bukaScanner('nisSiswa')" class="absolute right-2 top-[22px] bottom-2 bg-indigo-600 text-white px-4 rounded-xl font-black text-[10px] hover:bg-indigo-700 transition-all">üì∑ SCAN</button>
            </div>

            <div id="infoSiswa" class="hidden p-5 rounded-2xl border-2 transition-all duration-300">
                <div class="flex items-center gap-4">
                    <div id="iconSiswa" class="text-3xl">üë§</div>
                    <div>
                        <p id="namaSiswaDisplay" class="font-black text-indigo-900 uppercase text-sm leading-tight"></p>
                        <p id="kelasSiswaDisplay" class="text-[10px] font-bold text-slate-500 uppercase"></p>
                    </div>
                </div>
            </div>

            <hr class="border-slate-100">

            <div class="relative">
                <label class="text-[8px] font-black text-slate-400 ml-3 uppercase italic">2. Barcode / Kode Buku</label>
                <input type="text" id="barcodeBuku" autocomplete="off" oninput="cariBuku(this.value.trim())" placeholder="KODE BUKU / KETIK MANUAL..." 
                    class="w-full p-5 bg-slate-50 rounded-2xl font-black outline-none border-2 border-transparent focus:border-orange-500 uppercase text-sm tracking-widest transition-all">
                <button onclick="bukaScanner('barcodeBuku')" class="absolute right-2 top-[22px] bottom-2 bg-orange-500 text-white px-4 rounded-xl font-black text-[10px] hover:bg-orange-600 transition-all">üì∑ SCAN</button>
            </div>

            <div id="infoBuku" class="hidden p-5 rounded-2xl border-2 transition-all duration-300">
                <div class="flex items-center gap-4">
                    <div id="iconBuku" class="text-3xl">üìñ</div>
                    <div>
                        <p id="judulBukuDisplay" class="font-black text-slate-900 uppercase text-sm leading-tight"></p>
                        <p id="stokBukuDisplay" class="text-[10px] font-bold uppercase"></p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 pt-4">
                <button id="btnPinjam" onclick="prosesTransaksi('PINJAM')" class="bg-indigo-600 text-white font-black py-5 rounded-3xl shadow-lg hover:bg-indigo-700 active:scale-95 transition-all uppercase italic text-xs tracking-widest disabled:opacity-30 disabled:cursor-not-allowed">Pinjam üì§</button>
                <button id="btnKembali" onclick="prosesTransaksi('KEMBALI')" class="bg-emerald-500 text-white font-black py-5 rounded-3xl shadow-lg hover:bg-emerald-600 active:scale-95 transition-all uppercase italic text-xs tracking-widest disabled:opacity-30 disabled:cursor-not-allowed">Kembali üì•</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://e-perpus-a652c-default-rtdb.asia-southeast1.firebasedatabase.app" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let html5QrCode = null;
        let listenerSiswa = null;
        let listenerBuku = null;

        // --- SISTEM CARI SISWA ---
        function cariSiswa(nis) {
            const info = document.getElementById('infoSiswa');
            if(!nis) { info.classList.add('hidden'); return; }
            
            if (listenerSiswa) db.ref('anggota_perpus/' + nis).off();
            
            listenerSiswa = db.ref('anggota_perpus/' + nis).on('value', snap => {
                info.classList.remove('hidden');
                if(snap.exists()){
                    const s = snap.val();
                    document.getElementById('namaSiswaDisplay').innerText = s.nama;
                    document.getElementById('kelasSiswaDisplay').innerText = `KELAS: ${s.kelas} | STATUS: ${s.status}`;
                    info.className = "p-5 rounded-2xl border-2 bg-emerald-50 border-emerald-100";
                    document.getElementById('iconSiswa').innerText = "‚úÖ";
                } else {
                    document.getElementById('namaSiswaDisplay').innerText = "SISWA TIDAK TERDAFTAR";
                    document.getElementById('kelasSiswaDisplay').innerText = "Cek NISN atau Aktivasi Member";
                    info.className = "p-5 rounded-2xl border-2 bg-red-50 border-red-100";
                    document.getElementById('iconSiswa').innerText = "‚ùå";
                }
            });
        }

        // --- SISTEM CARI BUKU (DIPERKUAT UNTUK KETIK MANUAL) ---
        function cariBuku(barcode) {
            const info = document.getElementById('infoBuku');
            if(!barcode) { info.classList.add('hidden'); return; }

            if (listenerBuku) db.ref('koleksi_buku/' + barcode).off();

            listenerBuku = db.ref('koleksi_buku/' + barcode).on('value', snap => {
                info.classList.remove('hidden');
                if(snap.exists()){
                    const b = snap.val();
                    document.getElementById('judulBukuDisplay').innerText = b.judul;
                    document.getElementById('stokBukuDisplay').innerText = `STOK: ${b.stok_tersedia} | RAK: ${b.lokasi || '-'}`;
                    document.getElementById('stokBukuDisplay').className = "text-[10px] font-bold uppercase " + (b.stok_tersedia > 0 ? "text-emerald-600" : "text-red-600");
                    info.className = "p-5 rounded-2xl border-2 bg-orange-50 border-orange-200";
                    document.getElementById('iconBuku').innerText = "üìñ";
                } else {
                    document.getElementById('judulBukuDisplay').innerText = "BUKU TIDAK DITEMUKAN";
                    document.getElementById('stokBukuDisplay').innerText = "Pastikan Kode Barcode Benar";
                    document.getElementById('stokBukuDisplay').className = "text-[10px] font-bold uppercase text-red-500";
                    info.className = "p-5 rounded-2xl border-2 bg-red-50 border-red-100";
                    document.getElementById('iconBuku').innerText = "‚ùì";
                }
            });
        }

        // --- TRANSAKSI (ANTI LAG & VALIDASI KETAT) ---
        async function prosesTransaksi(tipe) {
            const nis = document.getElementById('nisSiswa').value.trim();
            const barcode = document.getElementById('barcodeBuku').value.trim();
            const nama = document.getElementById('namaSiswaDisplay').innerText;
            const judul = document.getElementById('judulBukuDisplay').innerText;
            
            if(!nis || !barcode || nama.includes("TIDAK") || judul.includes("TIDAK")) {
                return alert("Mohon lengkapi data Siswa dan Buku dengan benar!");
            }

            // Kunci tombol
            const bPinjam = document.getElementById('btnPinjam');
            const bKembali = document.getElementById('btnKembali');
            bPinjam.disabled = true; bKembali.disabled = true;

            const tglSkrg = new Date().toLocaleString('id-ID');
            const tsSkrg = Date.now();

            try {
                if (tipe === 'PINJAM') {
                    // Cek Stok Realtime dari Server (Bukan dari tampilan)
                    const stokSnap = await db.ref(`koleksi_buku/${barcode}/stok_tersedia`).once('value');
                    if(!stokSnap.exists() || stokSnap.val() <= 0) throw new Error("Stok Buku Habis atau Tidak Tersedia!");

                    // Cek apakah siswa sedang meminjam buku yang sama
                    const cekSnap = await db.ref('perpus_laporan').orderByChild('idSiswa').equalTo(nis).once('value');
                    let sedangPinjam = false;
                    cekSnap.forEach(c => { if(c.val().idBuku === barcode && c.val().status === "DIPINJAM") sedangPinjam = true; });
                    if(sedangPinjam) throw new Error("Siswa ini masih meminjam buku tersebut!");

                    // Push Laporan
                    await db.ref('perpus_laporan').push({
                        idSiswa: nis, namaSiswa: nama, idBuku: barcode, judulBuku: judul,
                        status: "DIPINJAM", waktuPinjam: tglSkrg, waktuKembali: "-", timestamp: tsSkrg
                    });
                    
                    // Potong Stok
                    await db.ref(`koleksi_buku/${barcode}`).transaction(b => {
                        if(b) b.stok_tersedia = (parseInt(b.stok_tersedia) || 0) - 1;
                        return b;
                    });
                    
                    alert("‚úÖ BERHASIL PINJAM");
                } else {
                    // PROSES KEMBALI
                    const snap = await db.ref('perpus_laporan').orderByChild('idSiswa').equalTo(nis).once('value');
                    let targetKey = null;
                    let tsPinjam = 0;

                    snap.forEach(child => {
                        const d = child.val();
                        if (d.idBuku === barcode && d.status === "DIPINJAM") {
                            targetKey = child.key;
                            tsPinjam = d.timestamp;
                        }
                    });

                    if (!targetKey) throw new Error("Data peminjaman tidak ditemukan untuk siswa & buku ini!");

                    // Hitung Denda (7 Hari batas)
                    const selisihHari = Math.floor((tsSkrg - tsPinjam) / (1000 * 60 * 60 * 24));
                    const denda = (selisihHari > 7) ? (selisihHari - 7) * 1000 : 0;

                    // Update Laporan
                    await db.ref('perpus_laporan/' + targetKey).update({
                        status: "DIKEMBALIKAN", waktuKembali: tglSkrg, denda_final: denda, waktu_proses: tsSkrg
                    });

                    // Tambah Stok
                    await db.ref(`koleksi_buku/${barcode}`).transaction(b => {
                        if(b) b.stok_tersedia = (parseInt(b.stok_tersedia) || 0) + 1;
                        return b;
                    });

                    alert(`‚úÖ BERHASIL KEMBALI\nDenda: Rp ${denda.toLocaleString()}`);
                }
                resetInput();
            } catch (err) {
                alert("Kesalahan: " + err.message);
            } finally {
                bPinjam.disabled = false; bKembali.disabled = false;
            }
        }

        function resetInput() {
            document.getElementById('barcodeBuku').value = "";
            document.getElementById('infoBuku').classList.add('hidden');
            document.getElementById('barcodeBuku').focus();
        }

        // --- SCANNER ---
        function bukaScanner(idTujuan) {
            document.getElementById('scannerArea').classList.remove('hidden');
            if(html5QrCode) html5QrCode.stop();
            
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 25, qrbox: 250 }, (txt) => {
                const hasil = txt.trim();
                document.getElementById(idTujuan).value = hasil;
                if(idTujuan === 'nisSiswa') cariSiswa(hasil);
                if(idTujuan === 'barcodeBuku') cariBuku(hasil);
                tutupScanner();
                new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3').play().catch(()=>{});
            });
        }

        function tutupScanner() {
            if (html5QrCode) {
                html5QrCode.stop().finally(() => {
                    document.getElementById('scannerArea').classList.add('hidden');
                });
            }
        }
    </script>
</body>
</html>
