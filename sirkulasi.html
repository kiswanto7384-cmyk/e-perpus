<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sirkulasi Realtime - E-Perpus SDN 169</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen pb-10">

    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200 px-4 py-3 mb-6">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <a href="menu-perpus.html" class="flex items-center gap-2">
                <span class="text-xl">üè†</span>
                <span class="font-black text-indigo-900 italic text-sm uppercase">Menu Utama</span>
            </a>
            <a href="pengembalian.html" class="px-3 py-2 rounded-xl text-[9px] font-black uppercase bg-indigo-100 text-indigo-600 shadow-sm hover:bg-indigo-200">üìë Log Pengembalian</a>
        </div>
    </nav>

    <div class="max-w-2xl mx-auto px-4">
        <div class="bg-indigo-600 text-white p-6 rounded-[2.5rem] shadow-xl mb-6 border-b-8 border-indigo-800">
            <h1 class="text-xl font-black uppercase italic leading-none text-yellow-400">Kasir Sirkulasi üîÑ</h1>
            <p class="text-[9px] font-bold opacity-80 uppercase tracking-widest mt-2 italic">Akses Multi-Perangkat Tanpa Lag</p>
        </div>

        <div id="scannerArea" class="hidden mb-6 rounded-[2.5rem] overflow-hidden border-4 border-indigo-500 bg-black relative shadow-2xl">
            <div id="reader" style="width: 100%; min-height: 250px;"></div>
            <button onclick="tutupScanner()" class="w-full bg-red-600 text-white py-4 font-black text-xs uppercase tracking-widest">Batal Scan ‚ùå</button>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-200 space-y-4">
            
            <div class="relative">
                <label class="text-[8px] font-black text-slate-400 ml-3 uppercase italic">1. Identitas Peminjam</label>
                <input type="text" id="nisSiswa" oninput="cariSiswa(this.value.trim())" placeholder="ID SISWA / SCAN..." 
                    class="w-full p-5 bg-slate-50 rounded-2xl font-black outline-none border-2 border-transparent focus:border-indigo-500 uppercase text-sm tracking-widest transition-all">
                <button onclick="bukaScanner('nisSiswa')" class="absolute right-2 top-[22px] bottom-2 bg-indigo-600 text-white px-4 rounded-xl font-black text-[10px] hover:bg-indigo-700 transition-all">üì∑ SCAN</button>
            </div>

            <div id="infoSiswa" class="hidden p-5 rounded-2xl border-2 transition-all duration-300">
                <div class="flex items-center gap-4">
                    <div id="iconSiswa" class="text-3xl">üë§</div>
                    <div>
                        <p id="namaSiswaDisplay" class="font-black text-indigo-900 uppercase text-sm leading-tight"></p>
                        <p id="kelasSiswaDisplay" class="text-[10px] font-bold text-slate-500 uppercase"></p>
                    </div>
                </div>
            </div>

            <hr class="border-slate-100">

            <div class="relative">
                <label class="text-[8px] font-black text-slate-400 ml-3 uppercase italic">2. Barcode Buku</label>
                <input type="text" id="barcodeBuku" oninput="cariBuku(this.value.trim())" placeholder="KODE BUKU / SCAN..." 
                    class="w-full p-5 bg-slate-50 rounded-2xl font-black outline-none border-2 border-transparent focus:border-orange-500 uppercase text-sm tracking-widest transition-all">
                <button onclick="bukaScanner('barcodeBuku')" class="absolute right-2 top-[22px] bottom-2 bg-orange-500 text-white px-4 rounded-xl font-black text-[10px] hover:bg-orange-600 transition-all">üì∑ SCAN</button>
            </div>

            <div id="infoBuku" class="hidden p-5 bg-orange-50 rounded-2xl border-2 border-orange-100 transition-all">
                <div class="flex items-center gap-4">
                    <div class="text-3xl">üìñ</div>
                    <div>
                        <p id="judulBukuDisplay" class="font-black text-orange-900 uppercase text-sm leading-tight"></p>
                        <p id="stokBukuDisplay" class="text-[10px] font-bold text-orange-500 uppercase"></p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 pt-4">
                <button id="btnPinjam" onclick="prosesTransaksi('PINJAM')" class="bg-indigo-600 text-white font-black py-5 rounded-3xl shadow-lg hover:bg-indigo-700 active:scale-95 transition-all uppercase italic text-xs tracking-widest disabled:opacity-30">Pinjam üì§</button>
                <button id="btnKembali" onclick="prosesTransaksi('KEMBALI')" class="bg-emerald-500 text-white font-black py-5 rounded-3xl shadow-lg hover:bg-emerald-600 active:scale-95 transition-all uppercase italic text-xs tracking-widest disabled:opacity-30">Kembali üì•</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://e-perpus-a652c-default-rtdb.asia-southeast1.firebasedatabase.app" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let html5QrCode = null;
        let siswaAktifListener = null;
        let bukuAktifListener = null;

        // --- SINKRONISASI SISWA REALTIME ---
        function cariSiswa(nis) {
            if(!nis) { document.getElementById('infoSiswa').classList.add('hidden'); return; }
            
            if (siswaAktifListener) db.ref('anggota_perpus/' + nis).off();
            
            siswaAktifListener = db.ref('anggota_perpus/' + nis).on('value', snap => {
                const info = document.getElementById('infoSiswa');
                const nama = document.getElementById('namaSiswaDisplay');
                const kelas = document.getElementById('kelasSiswaDisplay');
                info.classList.remove('hidden');

                if(snap.exists()){
                    const s = snap.val();
                    nama.innerText = s.nama;
                    kelas.innerText = `KELAS: ${s.kelas} | SALDO: Rp ${(s.saldo || 0).toLocaleString()}`;
                    info.className = "p-5 rounded-2xl border-2 bg-emerald-50 border-emerald-100";
                    document.getElementById('iconSiswa').innerText = "‚úÖ";
                } else {
                    nama.innerText = "MEMBER TIDAK DITEMUKAN";
                    kelas.innerText = "CEK KEMBALI ID SISWA";
                    info.className = "p-5 rounded-2xl border-2 bg-red-50 border-red-100";
                    document.getElementById('iconSiswa').innerText = "‚ùå";
                }
            });
        }

        // --- SINKRONISASI BUKU REALTIME ---
        function cariBuku(barcode) {
            if(!barcode) { document.getElementById('infoBuku').classList.add('hidden'); return; }

            if (bukuAktifListener) db.ref('koleksi_buku/' + barcode).off();

            bukuAktifListener = db.ref('koleksi_buku/' + barcode).on('value', snap => {
                const info = document.getElementById('infoBuku');
                if(snap.exists()){
                    const b = snap.val();
                    info.classList.remove('hidden');
                    document.getElementById('judulBukuDisplay').innerText = b.judul;
                    document.getElementById('stokBukuDisplay').innerText = `STOK TERSEDIA: ${b.stok_tersedia}`;
                } else {
                    info.classList.add('hidden');
                }
            });
        }

        async function prosesTransaksi(tipe) {
            const nis = document.getElementById('nisSiswa').value.trim();
            const barcode = document.getElementById('barcodeBuku').value.trim();
            const nama = document.getElementById('namaSiswaDisplay').innerText;
            const judul = document.getElementById('judulBukuDisplay').innerText;
            
            if(!nis || !barcode || nama.includes("TIDAK DITEMUKAN")) return alert("Data Siswa atau Buku tidak valid!");

            const tglSkrg = new Date().toLocaleString('id-ID');
            const tsSkrg = new Date().getTime();

            // DISABLE TOMBOL AGAR TIDAK DOUBLE KLIK (Penyebab lag/data ganda)
            document.getElementById('btnPinjam').disabled = true;
            document.getElementById('btnKembali').disabled = true;

            try {
                if (tipe === 'PINJAM') {
                    // Validasi Stok lewat server bukan lewat tampilan (Anti-Lag)
                    const stokRef = db.ref('koleksi_buku/' + barcode + '/stok_tersedia');
                    const stokSnap = await stokRef.once('value');
                    if(stokSnap.val() <= 0) throw new Error("Stok Buku Habis!");

                    await db.ref('perpus_laporan').push({
                        idSiswa: nis, namaSiswa: nama, idBuku: barcode, judulBuku: judul,
                        status: "DIPINJAM", waktuPinjam: tglSkrg, waktuKembali: "-", timestamp: tsSkrg
                    });
                    await updateStok(barcode, -1);
                    alert("‚úÖ PINJAM BERHASIL");
                } else {
                    // LOGIKA KEMBALI
                    const snap = await db.ref('perpus_laporan').orderByChild('idSiswa').equalTo(nis).once('value');
                    let targetKey = null;
                    let tsPinjam = 0;

                    snap.forEach(child => {
                        const d = child.val();
                        if (d.idBuku === barcode && d.status === "DIPINJAM") {
                            targetKey = child.key;
                            tsPinjam = d.timestamp;
                        }
                    });

                    if (targetKey) {
                        const selisihHari = Math.floor((tsSkrg - tsPinjam) / (1000 * 60 * 60 * 24));
                        const denda = (selisihHari > 7) ? (selisihHari - 7) * 1000 : 0;

                        await db.ref('perpus_laporan/' + targetKey).update({
                            status: "DIKEMBALIKAN", waktuKembali: tglSkrg, denda_final: denda, waktu_proses: tsSkrg
                        });
                        await updateStok(barcode, 1);
                        if(denda > 0) await updateSaldo(nis, denda);
                        alert(`‚úÖ BUKU KEMBALI\nDenda: Rp ${denda.toLocaleString()}`);
                    } else {
                        alert("Data pinjaman tidak ditemukan!");
                    }
                }
                resetInput();
            } catch (e) {
                alert("Gagal: " + e.message);
            } finally {
                document.getElementById('btnPinjam').disabled = false;
                document.getElementById('btnKembali').disabled = false;
            }
        }

        function updateStok(id, qty) {
            return db.ref('koleksi_buku/' + id).transaction(c => {
                if(c) c.stok_tersedia = (parseInt(c.stok_tersedia) || 0) + qty;
                return c;
            });
        }

        async function updateSaldo(nis, denda) {
            const ref = db.ref('anggota_perpus/' + nis);
            return ref.transaction(c => {
                if(c) c.saldo = (parseInt(c.saldo) || 0) - denda;
                return c;
            });
        }

        function resetInput() {
            document.getElementById('barcodeBuku').value = "";
            document.getElementById('infoBuku').classList.add('hidden');
            document.getElementById('barcodeBuku').focus();
        }

        // SCANNER (Tetap Keren)
        function bukaScanner(idTujuan) {
            document.getElementById('scannerArea').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, (txt) => {
                document.getElementById(idTujuan).value = txt.trim();
                if(idTujuan === 'nisSiswa') cariSiswa(txt.trim());
                if(idTujuan === 'barcodeBuku') cariBuku(txt.trim());
                tutupScanner();
                new Audio('https://www.soundjay.com/buttons/beep-07.mp3').play().catch(()=>{});
            });
        }

        function tutupScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scannerArea').classList.add('hidden');
                }).catch(() => document.getElementById('scannerArea').classList.add('hidden'));
            }
        }
    </script>
</body>
</html>
