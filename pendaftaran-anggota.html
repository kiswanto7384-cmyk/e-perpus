<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendaftaran Anggota - E-Perpus</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="bg-slate-100 p-4 font-sans min-h-screen">

    <div class="max-w-xl mx-auto">
        <div class="bg-indigo-900 text-white p-6 rounded-[2rem] shadow-xl mb-6 border-b-8 border-orange-500">
            <h1 class="text-xl font-black uppercase italic">Manajemen Anggota ğŸ‘¥</h1>
            <p class="text-[10px] font-bold opacity-60 uppercase tracking-widest">E-Perpus Integrated System</p>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <button onclick="salinSemuaDariKantin()" class="bg-orange-500 hover:bg-orange-600 text-white p-4 rounded-3xl shadow-lg transition-all flex flex-col items-center justify-center border-b-4 border-orange-700">
                <span class="text-2xl mb-1">ğŸ“¥</span>
                <span class="text-[10px] font-black uppercase leading-tight">Impor Semua<br>Dari E-Kantin</span>
            </button>
            <button onclick="toggleManual()" class="bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-3xl shadow-lg transition-all flex flex-col items-center justify-center border-b-4 border-indigo-800">
                <span class="text-2xl mb-1">ğŸ“</span>
                <span class="text-[10px] font-black uppercase leading-tight">Pendaftaran<br>Manual / Scan</span>
            </button>
        </div>

        <div id="scannerArea" class="hidden mb-4 rounded-[2rem] overflow-hidden border-4 border-indigo-600 bg-black">
            <div id="reader" style="width: 100%;"></div>
            <button onclick="tutupScanner()" class="w-full bg-red-600 text-white py-3 font-black uppercase text-xs">Tutup Kamera</button>
        </div>

        <div id="formManual" class="hidden bg-white p-6 rounded-[2.5rem] shadow-md border border-slate-200 mb-8 animate-all">
            <h2 class="text-center font-black text-indigo-900 text-xs uppercase mb-4 tracking-widest">Input Anggota Baru</h2>
            <div class="space-y-3">
                <div class="relative">
                    <input type="text" id="idSiswa" placeholder="ID KARTU / SCAN" class="w-full p-4 bg-slate-100 rounded-2xl font-black outline-none border-2 border-transparent focus:border-indigo-500">
                    <button onclick="bukaScanner()" class="absolute right-2 top-2 bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold text-[10px]">SCAN ğŸ“·</button>
                </div>
                <input type="text" id="namaSiswa" placeholder="NAMA SISWA" class="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-slate-100 uppercase text-sm outline-none focus:border-indigo-400">
                <input type="text" id="kelasSiswa" placeholder="KELAS" class="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-slate-100 uppercase text-sm outline-none focus:border-indigo-400">
                <button onclick="simpanSiswa()" class="w-full bg-emerald-500 text-white font-black py-4 rounded-2xl shadow-md uppercase text-xs tracking-widest mt-2">Simpan Anggota âœ…</button>
            </div>
        </div>

        <div class="flex justify-between items-center px-4 mb-4">
            <h3 class="font-black text-slate-400 text-[10px] uppercase tracking-widest">Anggota Terdaftar</h3>
            <span id="countAnggota" class="bg-white text-indigo-900 text-[10px] font-black px-3 py-1 rounded-full shadow-sm">0</span>
        </div>
        <div id="listAnggota" class="space-y-3"></div>
    </div>

    <script>
        // --- CONFIG FIREBASE ---
        const perpusConfig = {
            apiKey: "AIzaSyBXt0gEgczYD1jQ9OhNk5FGN8CePIFaSYw",
            databaseURL: "https://e-perpus-a652c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "e-perpus-a652c"
        };
        // Masukkan Config Kantin Bapak di sini
        const kantinConfig = {
            apiKey: "API_KEY_KANTIN",
            databaseURL: "URL_KANTIN_BAPAK",
            projectId: "ID_KANTIN"
        };

        const appPerpus = firebase.initializeApp(perpusConfig, "perpus");
        const appKantin = firebase.initializeApp(kantinConfig, "kantin");
        const dbPerpus = appPerpus.database();
        const dbKantin = appKantin.database();

        let html5QrCode;

        // 1. SISTEM GENERATE OTOMATIS (SALIN SEMUA)
        async function salinSemuaDariKantin() {
            if(confirm("Apakah Bapak yakin ingin menarik semua data siswa dari E-Kantin menjadi anggota Perpus?")) {
                const snapKantin = await dbKantin.ref('kantin_users').once('value');
                if(snapKantin.exists()) {
                    let jumlah = 0;
                    snapKantin.forEach(child => {
                        const data = child.val();
                        dbPerpus.ref('anggota_perpus/' + child.key).set({
                            id: child.key,
                            nama: data.nama,
                            kelas: data.kelas || "-",
                            status: "AKTIF",
                            total_pinjam: 0,
                            tgl_daftar: new Date().toLocaleDateString('id-ID')
                        });
                        jumlah++;
                    });
                    alert("Selesai! " + jumlah + " siswa berhasil didaftarkan otomatis.");
                } else {
                    alert("Data di E-Kantin tidak ditemukan.");
                }
            }
        }

        // 2. SISTEM MANUAL & SCAN
        function toggleManual() {
            const form = document.getElementById('formManual');
            form.classList.toggle('hidden');
        }

        function bukaScanner() {
            document.getElementById('scannerArea').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (id) => {
                document.getElementById('idSiswa').value = id.trim();
                tutupScanner();
            }).catch(() => alert("Kamera Error"));
        }

        function tutupScanner() {
            if(html5QrCode) html5QrCode.stop();
            document.getElementById('scannerArea').classList.add('hidden');
        }

        function simpanSiswa() {
            const id = document.getElementById('idSiswa').value.trim();
            const nama = document.getElementById('namaSiswa').value.trim().toUpperCase();
            const kelas = document.getElementById('kelasSiswa').value.trim().toUpperCase();
            if(id && nama) {
                dbPerpus.ref('anggota_perpus/' + id).set({
                    id, nama, kelas,
                    status: "AKTIF", total_pinjam: 0,
                    tgl_daftar: new Date().toLocaleDateString('id-ID')
                }).then(() => {
                    alert("Berhasil!");
                    document.getElementById('idSiswa').value = "";
                    document.getElementById('namaSiswa').value = "";
                    document.getElementById('kelasSiswa').value = "";
                });
            }
        }

        // TAMPILKAN LIST
        dbPerpus.ref('anggota_perpus').on('value', snap => {
            const list = document.getElementById('listAnggota');
            const count = document.getElementById('countAnggota');
            list.innerHTML = "";
            let total = 0;
            snap.forEach(sSnap => {
                total++;
                const s = sSnap.val();
                list.innerHTML += `
                    <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-200 flex justify-between items-center">
                        <div>
                            <p class="text-[7px] font-black text-indigo-500 uppercase leading-none">ID: ${s.id}</p>
                            <h3 class="font-black text-[11px] uppercase text-slate-800 mt-1">${s.nama}</h3>
                            <p class="text-[9px] font-bold text-slate-400 uppercase">${s.kelas}</p>
                        </div>
                        <button onclick="if(confirm('Hapus?')) dbPerpus.ref('anggota_perpus/${s.id}').remove()" class="bg-slate-50 p-2 rounded-xl text-slate-300 hover:text-red-500 transition-all">ğŸ—‘ï¸</button>
                    </div>`;
            });
            count.innerText = total;
        });
    </script>
</body>
</html>
