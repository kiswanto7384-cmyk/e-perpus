<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Perpus - Pengembalian & Denda</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen p-4 font-sans text-slate-800">

    <div class="max-w-4xl mx-auto">
        <div class="bg-indigo-700 p-6 rounded-[2rem] text-white shadow-lg mb-6 flex justify-between items-center border-b-8 border-indigo-900">
            <div>
                <h1 class="text-2xl font-black italic uppercase tracking-tighter text-yellow-400">Pengembalian Buku ðŸ“¥</h1>
                <p class="text-[10px] font-bold opacity-80 uppercase tracking-widest">Integrasi Saldo E-Kantin Otomatis</p>
            </div>
            <div class="text-right">
                <p class="text-[10px] font-black opacity-60">TARIF DENDA</p>
                <p class="text-xl font-black text-white">Rp 1.000 <span class="text-[10px] opacity-50">/ hari</span></p>
            </div>
        </div>

        <div class="bg-white rounded-[2rem] shadow-xl overflow-hidden border border-slate-200">
            <div class="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <h2 class="font-black uppercase italic text-slate-600 text-sm">ðŸ“š Buku Belum Kembali</h2>
                <span id="totalPinjaman" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-[10px] font-black tracking-widest uppercase">0 Buku</span>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50 text-[9px] font-black uppercase text-slate-400 tracking-widest border-b">
                            <th class="p-5 text-center w-16">ID KARTU</th>
                            <th class="p-5">PEMINJAM</th>
                            <th class="p-5 text-center text-red-500">DENDA</th>
                            <th class="p-5 text-center">TINDAKAN</th>
                        </tr>
                    </thead>
                    <tbody id="tabelPinjaman" class="text-[11px]">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Gunakan Database URL yang sama dengan sirkulasi
        const firebaseConfig = { databaseURL: "https://e-perpus-a652c-default-rtdb.asia-southeast1.firebasedatabase.app" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const DENDA_PER_HARI = 1000;

        function muatDataPinjaman() {
            // Mengambil dari 'perpus_laporan' agar sinkron dengan halaman sirkulasi
            db.ref('perpus_laporan').on('value', snap => {
                const body = document.getElementById('tabelPinjaman');
                const countEl = document.getElementById('totalPinjaman');
                body.innerHTML = "";
                let count = 0;

                snap.forEach(child => {
                    const p = child.val();
                    const key = child.key;

                    // Hanya tampilkan yang statusnya "DIPINJAM"
                    if (p.status === "DIPINJAM") {
                        count++;
                        
                        // Hitung Denda (Contoh Sederhana: jika lebih dari 7 hari)
                        // Anda bisa menyesuaikan logika tgl_kembali di sini
                        let denda = 0; 
                        
                        body.innerHTML += `
                            <tr class="border-b border-slate-100 hover:bg-slate-50 transition-all">
                                <td class="p-5 text-center font-bold text-slate-400">#${p.idSiswa}</td>
                                <td class="p-5">
                                    <p class="font-black text-slate-700 uppercase leading-none">${p.namaSiswa}</p>
                                    <p class="text-[9px] font-bold text-indigo-500 uppercase italic mt-1">${p.judulBuku}</p>
                                </td>
                                <td class="p-5 text-center font-black text-sm text-red-600">
                                    Rp ${denda.toLocaleString()}
                                </td>
                                <td class="p-5 text-center">
                                    <button onclick="prosesKembali('${key}', '${p.idSiswa}', '${p.namaSiswa}', ${denda})" 
                                        class="bg-emerald-500 text-white px-5 py-2 rounded-xl font-black uppercase text-[9px] shadow-lg hover:bg-emerald-600 transition-all">
                                        Kembalikan âœ…
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                });
                countEl.innerText = count + " Buku Aktif";
            });
        }

        function prosesKembali(key, idSiswa, namaSiswa, totalDenda) {
            if (totalDenda > 0) {
                if (confirm(`Potong Saldo E-Kantin Rp ${totalDenda.toLocaleString()} untuk ${namaSiswa}?`)) {
                    // Cek Saldo Siswa (Path disesuaikan dengan struktur database Anda)
                    db.ref('anggota_perpus/' + idSiswa + '/saldo').once('value', snap => {
                        let saldoSkrg = snap.val() || 0;
                        if (saldoSkrg >= totalDenda) {
                            db.ref('anggota_perpus/' + idSiswa).update({
                                saldo: saldoSkrg - totalDenda
                            }).then(() => {
                                selesaikan(key);
                            });
                        } else {
                            alert("Saldo Tidak Cukup! Bayar Tunai.");
                            selesaikan(key);
                        }
                    });
                }
            } else {
                selesaikan(key);
            }
        }

        function selesaikan(key) {
            const tglSkrg = new Date().toLocaleString('id-ID');
            db.ref('perpus_laporan/' + key).update({
                status: "DIKEMBALIKAN",
                waktuKembali: tglSkrg
            }).then(() => {
                alert("Buku Berhasil Dikembalikan!");
            });
        }

        muatDataPinjaman();
    </script>
</body>
</html>
